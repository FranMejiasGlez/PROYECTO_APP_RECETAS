<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migaz Social - Recetas</title>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; color: #333; }
        
        /* LOGIN / REGISTRO */
        #auth-screen { display: flex; justify-content: center; align-items: center; height: 100vh; background: #eef2f3; }
        .auth-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        .auth-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .link { color: #3498db; cursor: pointer; font-size: 0.9em; margin-top: 10px; display: block; }

        /* DASHBOARD PRINCIPAL */
        #dashboard-screen { display: none; }
        
        header { background: white; padding: 15px 40px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5em; font-weight: bold; color: #e67e22; }
        .user-menu { display: flex; gap: 15px; align-items: center; }
        .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #ddd; }

        .main-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        /* COLUMNA IZQUIERDA (RECETAS) */
        .tabs { margin-bottom: 20px; border-bottom: 2px solid #ddd; display: flex; gap: 20px; }
        .tab { padding: 10px; cursor: pointer; font-weight: bold; color: #777; border-bottom: 3px solid transparent; }
        .tab.active { color: #3498db; border-bottom-color: #3498db; }
        
        #recetas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }

        /* TARJETAS */
        .card { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; position: relative; display: flex; flex-direction: column;}
        .card:hover { transform: translateY(-3px); transition: transform 0.2s; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .card-body { padding: 15px; }
        .card-title { margin: 0 0 10px 0; font-size: 1.2em; color: #2c3e50; }
        
        .save-btn { position: absolute; top: 10px; right: 10px; background: white; border-radius: 50%; width: 35px; height: 35px; border: none; cursor: pointer; font-size: 1.2em; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
        .saved { color: red; } 

        .card-actions { margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; }

        /* COLUMNA DERECHA (SOCIAL) */
        .sidebar-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .sidebar-title { font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .user-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        
        .btn-follow { padding: 5px 12px; border-radius: 20px; border: 1px solid #3498db; background: transparent; color: #3498db; cursor: pointer; font-size: 0.8em; }
        .btn-follow.following { background: #3498db; color: white; }
        
        /* Stats Clickables */
        .stat-box { display: flex; justify-content: space-around; margin: 10px 0; font-size: 0.9em; text-align: center; }
        .stat-item { cursor: pointer; padding: 5px; border-radius: 5px; transition: 0.2s; width: 45%; }
        .stat-item:hover { background-color: #f0f2f5; }
        .stat-num { font-weight: bold; font-size: 1.2em; display: block; }

        /* ESTILOS DE BOTONES */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9em; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f1c40f; color: #333; }
        .btn-outline { background: transparent; border: 1px solid #ccc; }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        /* Listas din√°micas */
        .dynamic-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .dynamic-row input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }

        /* Social List Item */
        .social-list-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-bottom: 1px solid #eee; }
        .social-list-item:last-child { border-bottom: none; }
        .social-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ddd; object-fit: cover; }
        .social-name { font-weight: bold; }

    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box" id="login-box">
            <h2 style="color:#e67e22">Bienvenido a Migaz</h2>
            <input type="email" id="login-email" placeholder="Correo electr√≥nico">
            <input type="password" id="login-pass" placeholder="Contrase√±a">
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="login()">Iniciar Sesi√≥n</button>
            <span class="link" onclick="toggleAuth('register')">¬øNo tienes cuenta? Reg√≠strate</span>
        </div>

        <div class="auth-box" id="register-box" style="display:none;">
            <h2 style="color:#2ecc71">Crear Cuenta</h2>
            <input type="email" id="reg-email" placeholder="Correo electr√≥nico">
            <input type="password" id="reg-pass" placeholder="Contrase√±a">
            <button class="btn btn-success" style="width:100%; margin-top:10px;" onclick="registro()">Registrarse</button>
            <span class="link" onclick="toggleAuth('login')">¬øYa tienes cuenta? Inicia sesi√≥n</span>
        </div>
    </div>

    <div id="dashboard-screen">
        <header>
            <div class="logo">üåÆ Migaz</div>
            <div class="user-menu">
                <span id="header-username">Cargando...</span>
                <img src="" id="header-avatar" class="avatar-small">
                <button class="btn btn-outline" onclick="abrirModalSettings()">‚öôÔ∏è</button>
                <button class="btn btn-outline" onclick="logout()">Salir</button>
            </div>
        </header>

        <div class="main-layout">
            <div>
                <div class="tabs">
                    <div class="tab active" onclick="cambiarTab('todas', this)">Explorar Recetas</div>
                    <div class="tab" onclick="cambiarTab('top', this)">üî• Top Valoradas</div>
                    <div class="tab" onclick="cambiarTab('guardadas', this)">Mis Guardadas ‚ù§Ô∏è</div>
                </div>
                
                <button class="btn btn-success" style="margin-bottom:20px; width:100%" onclick="abrirModalReceta()">+ Nueva Receta</button>
                
                <div id="recetas-grid"></div>
            </div>

            <div>
                <div class="sidebar-box">
                    <div style="text-align:center">
                        <img src="" id="sidebar-avatar" class="avatar-small" style="width:80px; height:80px; margin-bottom:10px;">
                        <h3 id="sidebar-username" style="margin:0">...</h3>
                        <p id="sidebar-bio" style="color:#777; font-size:0.9em">...</p>
                    </div>
                    <div class="stat-box">
                        <div class="stat-item" onclick="abrirModalSocial('siguiendo')">
                            <span class="stat-num" id="count-siguiendo">0</span>Siguiendo
                        </div>
                        <div class="stat-item" onclick="abrirModalSocial('seguidores')">
                            <span class="stat-num" id="count-seguidores">0</span>Seguidores
                        </div>
                    </div>
                </div>

                <div class="sidebar-box">
                    <div class="sidebar-title">Descubrir Personas</div>
                    <div id="users-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="modal">
        <div class="modal-content">
            <h2>Editar Perfil</h2>
            <div class="form-group"><label>Usuario</label><input type="text" id="set-username" class="form-control"></div>
            <div class="form-group"><label>Bio</label><input type="text" id="set-bio" class="form-control"></div>
            <div class="form-group"><label>Email</label><input type="email" id="set-email" class="form-control"></div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn btn-outline" onclick="cerrarModal('modal-settings')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarPerfil()">Guardar</button>
            </div>
        </div>
    </div>

    <div id="modal-social" class="modal">
        <div class="modal-content">
            <h2 id="social-title">Lista</h2>
            <div id="social-list-content" style="max-height: 400px; overflow-y: auto;"></div>
            <div style="text-align:right; margin-top:20px;">
                <button class="btn btn-outline" onclick="cerrarModal('modal-social')">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="modal-receta" class="modal">
        <div class="modal-content">
            <h2 id="modal-titulo" style="margin-top:0;">Receta</h2>
            <form id="form-receta">
                <input type="hidden" id="receta-id">

                <div class="form-group">
                    <label>Nombre del plato</label>
                    <input type="text" id="nombre" class="form-control" required placeholder="Ej: Paella Valenciana">
                </div>

                <div class="form-group">
                    <label>Descripci√≥n (Opcional)</label>
                    <textarea id="descripcion" class="form-control" rows="2" maxlength="500" placeholder="Breve descripci√≥n de tu receta..."></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Categor√≠a</label>
                        <select id="categoria" class="form-control" required>
                            <option value="" disabled selected>Cargando...</option>
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1;">
                        <label>Tiempo</label>
                        <input type="text" id="tiempo" class="form-control" required placeholder="Ej: 45 min">
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Comensales</label>
                        <input type="number" id="comensales" class="form-control" required min="1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Dificultad (1-5)</label>
                        <select id="dificultad" class="form-control">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Video Youtube (Opcional)</label>
                    <input type="text" id="youtube" class="form-control" placeholder="https://youtube.com/...">
                </div>

                <div class="form-group">
                    <label>Fotos (M√∫ltiples)</label>
                    <input type="file" id="input-fotos" class="form-control" multiple accept="image/*">
                </div>

                <div class="form-group">
                    <label>Ingredientes</label>
                    <div id="lista-ingredientes"></div>
                    <button type="button" class="btn btn-outline" onclick="agregarCampo('lista-ingredientes')">+ A√±adir Ingrediente</button>
                </div>

                <div class="form-group">
                    <label>Pasos</label>
                    <div id="lista-instrucciones"></div>
                    <button type="button" class="btn btn-outline" onclick="agregarCampo('lista-instrucciones')">+ A√±adir Paso</button>
                </div>

                <div style="text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal('modal-receta')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        const BASE_IMG = 'http://localhost:3000';
        let currentUser = null;
        let currentTab = 'todas';
        let recetasCache = [];

        // --- AUTH ---
        function toggleAuth(v) {
            document.getElementById('login-box').style.display = v==='login'?'block':'none';
            document.getElementById('register-box').style.display = v==='register'?'block':'none';
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            try {
                const res = await fetch(`${API_URL}/usuarios/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
                if(res.ok) iniciarSesionExitoso(await res.json());
                else alert('Error login');
            } catch(e){console.error(e);}
        }

        async function registro() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;
            try {
                const res = await fetch(`${API_URL}/usuarios/registro`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email,password})});
                if(res.ok) { alert('Creado'); toggleAuth('login'); }
                else alert('Error registro');
            } catch(e){console.error(e);}
        }

        function iniciarSesionExitoso(u) {
            currentUser = u;
            localStorage.setItem('migaz_user', JSON.stringify(u));
            document.getElementById('auth-screen').style.display='none';
            document.getElementById('dashboard-screen').style.display='block';
            
            cargarDatosUsuario();
            cargarOpcionesCategorias(); // <--- CARGAMOS CATEGORIAS AL ENTRAR
            cargarRecetas(); 
            cargarUsuariosSugeridos();
        }

        function logout() { localStorage.removeItem('migaz_user'); location.reload(); }
        window.onload = () => {
            const stored = localStorage.getItem('migaz_user');
            if(stored) {
                const u = JSON.parse(stored);
                fetch(`${API_URL}/usuarios/${u._id}`).then(r=>r.json()).then(nuevo => iniciarSesionExitoso(nuevo));
            }
        };

        // --- DASHBOARD ---
        function cargarDatosUsuario() {
            document.getElementById('header-username').innerText = currentUser.username;
            document.getElementById('sidebar-username').innerText = currentUser.username;
            document.getElementById('sidebar-bio').innerText = currentUser.bio || 'Sin bio';
            document.getElementById('count-siguiendo').innerText = currentUser.siguiendo ? currentUser.siguiendo.length : 0;
            document.getElementById('count-seguidores').innerText = currentUser.seguidores ? currentUser.seguidores.length : 0;
        }

        // --- CATEGOR√çAS (L√ìGICA NUEVA) ---
        async function cargarOpcionesCategorias() {
            const select = document.getElementById('categoria');
            select.innerHTML = '<option value="" disabled selected>Cargando...</option>';
            try {
                const res = await fetch(`${API_URL}/categorias`);
                const cats = await res.json();
                select.innerHTML = '<option value="" disabled selected>-- Selecciona --</option>';
                cats.forEach(c => {
                    // Capitalizar
                    const label = c.nombre.charAt(0).toUpperCase() + c.nombre.slice(1);
                    const opt = document.createElement('option');
                    opt.value = c.nombre;
                    opt.innerText = label;
                    select.appendChild(opt);
                });
            } catch(e) { console.error(e); select.innerHTML = '<option>Error</option>'; }
        }

        // --- RECETAS ---
        function cambiarTab(t, el) {
            currentTab = t;
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
            cargarRecetas();
        }

        async function cargarRecetas() {
            const div = document.getElementById('recetas-grid');
            div.innerHTML = '<p>Cargando...</p>';
            try {
                let lista = [];
                let url = `${API_URL}/recetas`; 

                if(currentTab === 'top') {
                    url = `${API_URL}/recetas/top`;
                    const r = await fetch(url);
                    lista = await r.json();

                } else if (currentTab === 'guardadas') {
                    const r = await fetch(`${API_URL}/usuarios/${currentUser._id}`);
                    const u = await r.json();
                    currentUser = u; 
                    lista = u.recetas_guardadas || [];

                } else {
                    const r = await fetch(url);
                    lista = await r.json();
                }

                recetasCache = lista.filter(x => x._id); // Cache solo de las recetas v√°lidas
                renderRecetas(lista); 

            } catch(e){ 
                console.error(e);
                div.innerHTML='<p style="color:red">Error al cargar recetas.</p>'; 
            }
        }

        function renderRecetas(lista) {
            const div = document.getElementById('recetas-grid');
            div.innerHTML='';
            
            if(!lista || lista.length===0) return div.innerHTML='<p>No hay recetas.</p>';
            if(lista.error) return div.innerHTML=`<p>Error: ${lista.error}</p>`; 

            lista.forEach(r => {
                const saved = currentUser.recetas_guardadas.some(g => (g._id||g) === r._id);
                const img = (r.imagenes && r.imagenes.length>0) ? `${BASE_IMG}/${r.imagenes[0]}` : 'https://via.placeholder.com/300x200?text=Sin+Foto';
                
                // Mostrar bot√≥n Editar/Borrar si es mi receta
                let misBotones = '';
                // Simple comprobaci√≥n si el usuario es "andy" o el ID coincide
                if(r.user === currentUser.username || r.user === currentUser._id) {
                    misBotones = `
                        <button class="btn btn-warning" onclick="cargarEdicion('${r._id}')" style="font-size:0.7em">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="eliminarReceta('${r._id}')" style="font-size:0.7em">üóëÔ∏è</button>
                    `;
                }

                const el = document.createElement('div'); el.className='card';
                el.innerHTML = `
                    <button class="save-btn ${saved?'saved':''}" onclick="toggleSave('${r._id}')">‚ô•</button>
                    <img src="${img}" class="card-img">
                    <div class="card-body">
                        <h4 class="card-title">${r.nombre}</h4>
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <small>${r.categoria} ‚Ä¢ ${r.tiempo}</small>
                            <span style="color:#f1c40f; font-weight:bold">${r.promedio || 0}‚òÖ</span>
                        </div>
                        <div class="card-actions">
                            ${misBotones}
                            <button class="btn btn-primary" onclick="votarRapido('${r._id}')" style="font-size:0.7em; margin-left:auto">‚≠ê Votar</button>
                        </div>
                    </div>
                `;
                div.appendChild(el);
            });
        }

        async function toggleSave(rid) {
            await fetch(`${API_URL}/usuarios/${currentUser._id}/guardar-receta`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({recetaId:rid})});
            cargarRecetas();
        }
        
        async function votarRapido(id) {
            const p = prompt("Tu puntuaci√≥n (1-5):");
            if(p && p>=1 && p<=5) {
                await fetch(`${API_URL}/recetas/${id}/valorar`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({puntuacion:p, user:currentUser._id})});
                cargarRecetas();
            }
        }
        
        async function eliminarReceta(id) {
            if(confirm("¬øBorrar receta?")) {
                await fetch(`${API_URL}/recetas/${id}`, {method:'DELETE'});
                cargarRecetas();
            }
        }

        // --- GESTI√ìN DE MODAL RECETA ---
        const formReceta = document.getElementById('form-receta');
        
        function abrirModalReceta() {
            formReceta.reset();
            document.getElementById('receta-id').value = '';
            document.getElementById('modal-titulo').innerText = 'Nueva Receta';
            document.getElementById('lista-ingredientes').innerHTML='';
            document.getElementById('lista-instrucciones').innerHTML='';
            document.getElementById('categoria').value = ""; // Reset select
            agregarCampo('lista-ingredientes'); agregarCampo('lista-instrucciones');
            document.getElementById('modal-receta').style.display='flex';
        }

        window.cargarEdicion = (id) => {
            const r = recetasCache.find(x => x._id === id);
            if(!r) return;
            document.getElementById('receta-id').value = r._id;
            document.getElementById('nombre').value = r.nombre;
            document.getElementById('categoria').value = r.categoria; // Select autoselecciona si coincide value
            document.getElementById('comensales').value = r.comensales;
            document.getElementById('dificultad').value = r.dificultad;
            document.getElementById('tiempo').value = r.tiempo;
            document.getElementById('youtube').value = r.youtube || '';
            const lIng=document.getElementById('lista-ingredientes'); lIng.innerHTML='';
            const lInst=document.getElementById('lista-instrucciones'); lInst.innerHTML='';
            r.ingredientes.forEach(x=>agregarCampo('lista-ingredientes',x));
            r.instrucciones.forEach(x=>agregarCampo('lista-instrucciones',x));
            document.getElementById('modal-titulo').innerText = 'Editar Receta';
            document.getElementById('modal-receta').style.display = 'flex';
        }

        formReceta.addEventListener('submit', async (e) => {
            e.preventDefault();
            const ingInputs = [...document.querySelectorAll('#lista-ingredientes input')].map(i => i.value).filter(v => v.trim());
            const instInputs = [...document.querySelectorAll('#lista-instrucciones input')].map(i => i.value).filter(v => v.trim());

            if(ingInputs.length === 0 || instInputs.length === 0) return alert("Faltan campos");

            const formData = new FormData();
            formData.append('nombre', document.getElementById('nombre').value);
            formData.append('categoria', document.getElementById('categoria').value); // Select value
            formData.append('comensales', document.getElementById('comensales').value);
            formData.append('dificultad', document.getElementById('dificultad').value);
            formData.append('tiempo', document.getElementById('tiempo').value);
            formData.append('user', currentUser._id); // Usamos ID real

            const yt = document.getElementById('youtube').value;
            if(yt) formData.append('youtube', yt);

            ingInputs.forEach(val => formData.append('ingredientes', val));
            instInputs.forEach(val => formData.append('instrucciones', val));

            const fileInput = document.getElementById('input-fotos');
            for (let i = 0; i < fileInput.files.length; i++) {
                formData.append('imagenes', fileInput.files[i]);
            }

            const id = document.getElementById('receta-id').value;
            const url = id ? `${API_URL}/recetas/${id}` : `${API_URL}/recetas`;
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method: method, body: formData });
                if (res.ok) { cerrarModal('modal-receta'); cargarRecetas(); }
                else { 
                    const err = await res.json(); 
                    if(err.errors) alert(err.errors.map(e=>e.msg).join('\n'));
                    else alert('Error: ' + err.msg);
                }
            } catch(e) { console.error(e); }
        });

        function agregarCampo(id, val=''){
            const d=document.createElement('div'); d.className='dynamic-row';
            d.innerHTML=`<input type="text" value="${val}" required><button type="button" class="btn btn-sm-danger" onclick="this.parentElement.remove()">‚úï</button>`;
            document.getElementById(id).appendChild(d);
        }

        // --- SOCIAL ---
        async function cargarUsuariosSugeridos() {
            const div = document.getElementById('users-list');
            try {
                const r = await fetch(`${API_URL}/usuarios`);
                const list = await r.json();
                div.innerHTML='';
                list.forEach(u => {
                    if(u._id === currentUser._id) return;
                    const following = currentUser.siguiendo && currentUser.siguiendo.some(s => (s._id||s) === u._id);
                    const el = document.createElement('div'); el.className='user-item';
                    el.innerHTML = `
                        <div class="user-info"><div class="avatar-small" style="background:#ccc"></div><b>${u.username}</b></div>
                        <button class="btn-follow ${following?'following':''}" onclick="follow('${u._id}')">${following?'Siguiendo':'Seguir'}</button>
                    `;
                    div.appendChild(el);
                });
            } catch(e){ div.innerHTML='Error lista'; }
        }

        async function follow(targetId) {
            await fetch(`${API_URL}/usuarios/${currentUser._id}/seguir`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({idDestino:targetId})});
            const me = await fetch(`${API_URL}/usuarios/${currentUser._id}`);
            currentUser = await me.json();
            cargarDatosUsuario();
            cargarUsuariosSugeridos();
        }

        async function abrirModalSocial(tipo) {
            const container = document.getElementById('social-list-content');
            document.getElementById('social-title').innerText = tipo === 'siguiendo' ? 'Personas que sigues' : 'Tus seguidores';
            container.innerHTML = 'Cargando...';
            document.getElementById('modal-social').style.display = 'flex';
            try {
                const res = await fetch(`${API_URL}/usuarios/${currentUser._id}`);
                const u = await res.json();
                const lista = u[tipo] || [];
                container.innerHTML = '';
                if (lista.length === 0) { container.innerHTML = '<p>Lista vac√≠a.</p>'; return; }
                lista.forEach(p => {
                    const name = p.username || 'Usuario';
                    const d = document.createElement('div'); d.className = 'social-list-item';
                    d.innerHTML = `<div class="social-avatar" style="background:#ccc"></div><div class="social-name">${name}</div>`;
                    container.appendChild(d);
                });
            } catch(e) { container.innerHTML='Error'; }
        }

        // --- SETTINGS ---
        function abrirModalSettings() {
            document.getElementById('set-username').value=currentUser.username;
            document.getElementById('set-email').value=currentUser.email;
            document.getElementById('set-bio').value=currentUser.bio||'';
            document.getElementById('modal-settings').style.display='flex';
        }
        async function guardarPerfil() {
            const body = { username: document.getElementById('set-username').value, email: document.getElementById('set-email').value, bio: document.getElementById('set-bio').value };
            const r = await fetch(`${API_URL}/usuarios/${currentUser._id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
            if(r.ok) { currentUser=await r.json(); localStorage.setItem('migaz_user', JSON.stringify(currentUser)); cargarDatosUsuario(); cerrarModal('modal-settings'); }
        }

        function cerrarModal(id) { document.getElementById(id).style.display='none'; }
    </script>
</body>
</html>