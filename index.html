<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Recetas - Migaz</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        h1 { text-align: center; color: #444; }

        /* Botones */
        .btn { padding: 8px 15px; cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-warning { background-color: #ffc107; color: #333; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-outline { background: transparent; border: 2px dashed #aaa; color: #555; width: 100%; margin-top: 5px; }
        .btn-outline:hover { border-color: #007bff; color: #007bff; background: #eef; }
        .btn-sm-danger { background-color: #ffcccc; color: #cc0000; padding: 5px 10px; border-radius: 4px; font-weight: bold; margin-left: 5px; }

        /* Grid */
        #recetas-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;
        }

        /* Tarjetas */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 12px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; color: #0056b3; }
        .tag { background: #eef; padding: 2px 8px; border-radius: 10px; font-size: 0.85em; color: #555; }
        .card-actions { margin-top: 15px; display: flex; gap: 10px; border-top: 1px solid #eee; padding-top: 10px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Formularios */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* Inputs Din√°micos */
        .dynamic-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .dynamic-row { display: flex; align-items: center; gap: 5px; }
        .dynamic-row input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }

    </style>
</head>
<body>

    <h1>üåÆ Gestor de Recetas</h1>

    <div style="text-align: center;">
        <button class="btn btn-success" onclick="abrirModal()">+ Crear Nueva Receta</button>
    </div>

    <div id="recetas-container"></div>

    <div id="modal-receta" class="modal">
        <div class="modal-content">
            <h2 id="modal-titulo" style="margin-top:0;">Receta</h2>
            <form id="form-receta">
                <input type="hidden" id="receta-id">

                <div class="form-group">
                    <label>Nombre del plato</label>
                    <input type="text" id="nombre" class="form-control" required placeholder="Ej: Paella Valenciana">
                </div>

                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Categor√≠a</label>
                        <input type="text" id="categoria" class="form-control" required placeholder="Ej: Espa√±ola">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Tiempo</label>
                        <input type="text" id="tiempo" class="form-control" required placeholder="Ej: 45 min">
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Comensales</label>
                        <input type="number" id="comensales" class="form-control" required min="1">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Dificultad</label>
                        <select id="dificultad" class="form-control">
                            <option value="1">1 - Muy F√°cil</option>
                            <option value="2">2 - F√°cil</option>
                            <option value="3">3 - Media</option>
                            <option value="4">4 - Dif√≠cil</option>
                            <option value="5">5 - Chef</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ingredientes</label>
                    <div id="lista-ingredientes" class="dynamic-list"></div>
                    <button type="button" class="btn btn-outline" onclick="agregarCampo('lista-ingredientes')">+ A√±adir Ingrediente</button>
                </div>

                <div class="form-group">
                    <label>Pasos de preparaci√≥n</label>
                    <div id="lista-instrucciones" class="dynamic-list"></div>
                    <button type="button" class="btn btn-outline" onclick="agregarCampo('lista-instrucciones')">+ A√±adir Paso</button>
                </div>

                <div style="text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Receta</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api/recetas';
        let recetasCache = [];

        document.addEventListener('DOMContentLoaded', fetchRecetas);

        // --- 1. GESTI√ìN DE INPUTS DIN√ÅMICOS ---
        
        function agregarCampo(contenedorId, valor = '') {
            const container = document.getElementById(contenedorId);
            const div = document.createElement('div');
            div.className = 'dynamic-row';
            div.innerHTML = `
                <input type="text" value="${valor}" class="input-dinamico" placeholder="..." required>
                <button type="button" class="btn btn-sm-danger" onclick="eliminarFila(this)">‚úï</button>
            `;
            container.appendChild(div);
        }

        function eliminarFila(boton) {
            boton.parentElement.remove();
        }

        // --- 2. L√ìGICA DE API ---

        async function fetchRecetas() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                recetasCache = data;
                renderizarRecetas(data);
            } catch (error) {
                console.error(error);
                alert('No se pudo conectar al servidor');
            }
        }

        function renderizarRecetas(recetas) {
            const container = document.getElementById('recetas-container');
            container.innerHTML = '';

            if (!recetas || recetas.length === 0) {
                container.innerHTML = '<p style="text-align:center; width:100%;">No hay recetas a√∫n.</p>';
                return;
            }

            recetas.forEach(receta => {
                const card = document.createElement('div');
                card.className = 'card';
                // Generamos estrellas para la dificultad
                const estrellas = '‚≠ê'.repeat(receta.dificultad || 1);
                
                card.innerHTML = `
                    <h3>${receta.nombre}</h3>
                    <p><span class="tag">${receta.categoria}</span> <span class="tag">‚è± ${receta.tiempo}</span></p>
                    <p><strong>Dificultad:</strong> ${estrellas}</p>
                    <p><strong>Comensales:</strong> ${receta.comensales}</p>
                    <div class="card-actions">
                        <button class="btn btn-warning" onclick="cargarEdicion('${receta._id}')">Editar</button>
                        <button class="btn btn-danger" onclick="eliminarReceta('${receta._id}')">Borrar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 3. MODAL Y FORMULARIO ---

        const modal = document.getElementById('modal-receta');
        const form = document.getElementById('form-receta');

        function abrirModal() {
            form.reset();
            document.getElementById('receta-id').value = '';
            document.getElementById('modal-titulo').innerText = 'Nueva Receta';
            
            document.getElementById('lista-ingredientes').innerHTML = '';
            document.getElementById('lista-instrucciones').innerHTML = '';
            
            // A√±adimos campos vac√≠os obligatorios
            agregarCampo('lista-ingredientes');
            agregarCampo('lista-instrucciones');

            modal.style.display = 'flex';
        }

        function cerrarModal() {
            modal.style.display = 'none';
        }

        window.cargarEdicion = (id) => {
            const receta = recetasCache.find(r => r._id === id);
            if (!receta) return;

            document.getElementById('receta-id').value = receta._id;
            document.getElementById('nombre').value = receta.nombre;
            document.getElementById('categoria').value = receta.categoria;
            document.getElementById('comensales').value = receta.comensales;
            document.getElementById('dificultad').value = receta.dificultad;
            document.getElementById('tiempo').value = receta.tiempo;

            const containerIng = document.getElementById('lista-ingredientes');
            const containerInst = document.getElementById('lista-instrucciones');
            
            containerIng.innerHTML = '';
            containerInst.innerHTML = '';

            receta.ingredientes.forEach(ing => agregarCampo('lista-ingredientes', ing));
            receta.instrucciones.forEach(inst => agregarCampo('lista-instrucciones', inst));

            document.getElementById('modal-titulo').innerText = 'Editar Receta';
            modal.style.display = 'flex';
        };

        // ENVIAR FORMULARIO (Aqu√≠ estaba el problema principal)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const ingInputs = document.querySelectorAll('#lista-ingredientes .input-dinamico');
            const instInputs = document.querySelectorAll('#lista-instrucciones .input-dinamico');

            const ingredientesArray = Array.from(ingInputs).map(i => i.value).filter(v => v.trim() !== '');
            const instruccionesArray = Array.from(instInputs).map(i => i.value).filter(v => v.trim() !== '');

            // VALIDACI√ìN FRONTEND: Evitar enviar arrays vac√≠os
            if(ingredientesArray.length === 0 || instruccionesArray.length === 0) {
                alert("Debes a√±adir al menos un ingrediente y una instrucci√≥n.");
                return;
            }

            const datos = {
                nombre: document.getElementById('nombre').value,
                categoria: document.getElementById('categoria').value,
                // IMPORTANTE: Convertir a N√∫mero con parseInt
                comensales: parseInt(document.getElementById('comensales').value),
                dificultad: parseInt(document.getElementById('dificultad').value),
                tiempo: document.getElementById('tiempo').value,
                ingredientes: ingredientesArray,
                instrucciones: instruccionesArray,
                user: "andy"
            };

            const id = document.getElementById('receta-id').value;
            const url = id ? `${API_URL}/${id}` : API_URL;
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                if (res.ok) {
                    cerrarModal();
                    fetchRecetas();
                } else {
                    // AQU√ç CAPTURAMOS EL ERROR REAL DEL BACKEND
                    const errorData = await res.json();
                    console.log("Error del servidor:", errorData);
                    
                    // Mostramos los detalles si existen (express-validator devuelve 'errors')
                    if (errorData.errors) {
                        const mensajes = errorData.errors.map(e => `‚Ä¢ ${e.path}: ${e.msg}`).join('\n');
                        alert('Errores de validaci√≥n:\n' + mensajes);
                    } else {
                        alert('Error: ' + (errorData.msg || errorData.error || 'Desconocido'));
                    }
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexi√≥n');
            }
        });

        window.eliminarReceta = async (id) => {
            if(!confirm('¬øSeguro que quieres borrarla?')) return;
            try {
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if(res.ok) fetchRecetas();
                else alert("No se pudo eliminar");
            } catch(e) { console.error(e); }
        };

        window.onclick = (e) => { if(e.target == modal) cerrarModal(); }

    </script>
</body>
</html>